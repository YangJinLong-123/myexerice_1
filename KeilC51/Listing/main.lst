C51 COMPILER V9.52.0.0   MAIN                                                              04/16/2020 10:07:49 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Output\main.obj
COMPILER INVOKED BY: D:\Keil4\C51\BIN\C51.EXE ..\User\Source\Application\main.c LARGE OMF2 WARNINGLEVEL(0) OPTIMIZE(5,SP
                    -EED) BROWSE INCDIR(..\Library\FU68xx_Hardware_Driver\Include;..\User\Include) DEBUG PRINT(.\Listing\main.lst) TABS(2) OB
                    -JECT(.\Output\main.obj)

line level    source

   1          /**************************** (C) COPYRIGHT 2017 Fortiortech shenzhen *****************************
   2          * File Name          : main.c
   3          * Author             : Fortiortech Appliction Team
   4          * Version            : V1.0
   5          * Date               : 2017-12-27
   6          * Description        : This file contains main function used for Motor Control.
   7          ***************************************************************************************************
   8          * All Rights Reserved
   9          **************************************************************************************************/
  10          
  11          /* Includes -------------------------------------------------------------------------------------*/
  12          // #include <main.h>
  13          #include <FU68xx_2.h>
  14          #include <Myproject.h>
  15          
  16          /* Private typedef ------------------------------------------------------------------------------*/
  17          /* Private define -------------------------------------------------------------------------------*/
  18          /* Private macro --------------------------------------------------------------------------------*/
  19          /* Private variables ----------------------------------------------------------------------------*/
  20          /* Private function prototypes ------------------------------------------------------------------*/
  21          /* Private functions ----------------------------------------------------------------------------*/
  22          void SoftwareInit(void);
  23          void HardwareInit(void);
  24          void DebugSet(void);
  25          void MotorControlInit(void);
  26          
  27          extern uint32 Temp_value;
  28          
  29          uint8 test_flag = 0;
  30          /*-------------------------------------------------------------------------------------------------
  31                  Function Name : void main(void)
  32                  Description   : ä¸»å‡½æ•°ä¸»è¦åŠŸèƒ½æ˜¯åˆå§‹åŒ–ï¼ŒåŒ…æ‹¬ä¸Šç”µç­‰å¾…ï¼Œè½¯ä»¶åˆå§‹åŒ–ï¼Œç¡¬ä»¶å
             -ˆå§‹åŒ–ï¼Œè°ƒè¯•æ¨¡å¼è®¾ç½®ï¼Œä¸»å¾ªç¯æ‰«æã€‚
  33                                              è½¯ä»¶åˆå§‹åŒ–--åˆå§‹åŒ–æ‰€æœ‰å®šä¹‰çš„å˜é‡
  34                                              ç¡¬ä»¶åˆå§‹åŒ–--åˆå§‹åŒ–ç¡¬ä»¶è®¾å¤‡é…ç½®
  35                                              è°ƒè¯•æ¨¡å¼è®¾ç½®--è°ƒè¯•æ¨¡å¼
  36                  Input         : æ— 
  37                  Output        : æ— 
  38          -------------------------------------------------------------------------------------------------*/
  39          void main(void)
  40          {
  41   1          uint16 PowerUpCnt = 0;
  42   1        
  43   1          Temp_value = Temperature_Off;
  44   1          test_flag = 0;
  45   1          for(PowerUpCnt=0;PowerUpCnt<SystemPowerUpTime;PowerUpCnt++){};
  46   1      
  47   1          if((SW1==0)&&(SW2==0))
  48   1          {
  49   2            test_flag = 1;
  50   2          }       
  51   1          /*Software Init*/
  52   1          SoftwareInit();
C51 COMPILER V9.52.0.0   MAIN                                                              04/16/2020 10:07:49 PAGE 2   

  53   1      
  54   1          /*Hardware Init*/
  55   1          HardwareInit();
  56   1      
  57   1          /*è°ƒè¯•æ¨¡å¼è®¾ç½®--å†…éƒ¨å˜é‡æŸ¥è¯¢ï¼›CMPè¾“å‡ºæŸ¥è¯¢ï¼›ADCè§¦å‘ä¿¡å·æŸ¥è¯¢*/
  58   1          DebugSet();
  59   1            
  60   1          LEDControl();                 //ä¸Šç”µç‚¹äº®
  61   1      
  62   1          while(1)
  63   1          {
  64   2            GetCurrentOffset();                                                     // ç”µæµåç½®çš„è·å–
  65   2            MC_Control();                                                           // ä¸»æ§å‡½æ•°ï¼ŒçŠ¶æ€æ‰«æ 2.6k
  66   2      
  67   2            #if (!StartONOFF_Enable)                                                // è°ƒé€Ÿæ–¹å¼
  68   2                #if (SPEED_MODE == PWMMODE)                                         // PWMè°ƒé€Ÿæ¨¡å¼
              //                PWMInputCapture();                                            // PWM dutyè°ƒé€Ÿæ¨¡å¼
                            PWMScan();                                                      // PWMè°ƒé¢‘è°ƒé€Ÿæ¨¡å¼
              
                        #elif (SPEED_MODE == NONEMODE)                                      // ç›´æ¥ä¸Šç”µè¿è¡Œæ¨¡å¼
  73   2                    mcSpeedRamp.FlagONOFF   = 1;
  74   2      //                mcSpeedRamp.TargetValue = _Q15(60000 / MOTOR_SPEED_BASE);
  75   2                #endif
  76   2            #endif
  77   2          }
  78   1      }
  79          /*-------------------------------------------------------------------------------------------------
  80                  Function Name : void DebugSet(void)
  81                  Description   : è°ƒè¯•æ¨¡å¼é…ç½®
  82                  Input         : æ— 
  83                  Output        : æ— 
  84          -------------------------------------------------------------------------------------------------*/
  85          void DebugSet(void)
  86          {
  87   1          #if defined (SPI_DBG_HW)                                                    // ç¡¬ä»¶è°ƒè¯•æ¨¡å¼
                      Set_DBG_DMA(&HARD_SPIDATA);
                  #elif defined (SPI_DBG_SW)                                                  // è½¯ä»¶è°ƒè¯•æ¨¡å¼
                      Set_DBG_DMA(spidebug);
                  #endif
  92   1      
  93   1          #if defined (SPI_DBG_HW) && defined (SPI_DBG_SW)
                      #error Only one DBG mode can be selected
                  #endif
  96   1      
  97   1          SetReg(CMP_CR3, DBGSEL0 | DBGSEL1,  GP01_DBG_Conf);
  98   1          SetReg(CMP_CR3, CMPSEL0 | CMPSEL1 | CMPSEL2, GP07_DBG_Conf);
  99   1      }
 100          
 101          /*-------------------------------------------------------------------------------------------------
 102                  Function Name : void SoftwareInit(void)
 103                  Description   : è½¯ä»¶åˆå§‹åŒ–ï¼Œåˆå§‹åŒ–æ‰€æœ‰å®šä¹‰å˜é‡ï¼ŒæŒ‰é”®åˆå§‹åŒ–æ‰«æ
 104                  Input         : æ— 
 105                  Output        : æ— 
 106          -------------------------------------------------------------------------------------------------*/
 107          void SoftwareInit(void)
 108          {
 109   1          /****åˆå§‹åŒ–æ‰€æœ‰å®šä¹‰çš„å‚æ•°å˜é‡****/
 110   1          MotorcontrolInit();
 111   1        
 112   1         /******æŒ‰é”®åˆå§‹åŒ–******/
 113   1          KeyInit();
 114   1        
C51 COMPILER V9.52.0.0   MAIN                                                              04/16/2020 10:07:49 PAGE 3   

 115   1        /******LEDåˆå§‹åŒ–******/
 116   1          LEDControlInit();
 117   1        
 118   1          /****ç”µæœºåˆå§‹çŠ¶æ€ä¸ºmcReadyï¼Œæ•…éšœä¿æŠ¤ä¸ºæ— æ•…éšœ******/
 119   1          mcState = mcReady;
 120   1          mcFaultSource = 0;
 121   1      }
 122          
 123          /*-------------------------------------------------------------------------------------------------
 124                  Function Name : void HardwareInit(void)
 125                  Description   : ç¡¬ä»¶åˆå§‹åŒ–ï¼Œåˆå§‹åŒ–éœ€è¦ä½¿ç”¨çš„ç¡¬ä»¶è®¾å¤‡é…ç½®ï¼ŒFOCå¿…é¡»é…ç½®çš„æ
             -˜¯è¿æ”¾ç”µå‹ã€è¿æ”¾åˆå§‹åŒ–ã€ADCåˆå§‹åŒ–ã€Driveråˆå§‹åŒ–
 126                                              TIM4åˆå§‹åŒ–ï¼Œå…¶ä»–çš„å¯æ ¹æ®å®é™…éœ€æ±‚åŠ ã€‚
 127                  Input         : æ— 
 128                  Output        : æ— 
 129          -------------------------------------------------------------------------------------------------*/
 130          void HardwareInit(void)
 131          {
 132   1      
 133   1          // ä¸ºæé«˜èŠ¯ç‰‡çš„æŠ—å¹²æ‰°èƒ½åŠ›ï¼Œé™ä½èŠ¯ç‰‡åŠŸè€—ï¼Œè¯·åœ¨å…·ä½“é¡¹ç›®æ—¶ï¼Œå°†ä¸éœ€è¦ç”¨çš„
             -GPIOé»˜è®¤éƒ½é…ç½®ä¸ºè¾“å…¥ä¸Šæ‹‰ã€‚
 134   1          // å…·ä½“é…ç½®å¯åœ¨GPIO_Default_Initè®¾ç½®ã€‚
 135   1          //    GPIO_Default_Init();
 136   1      
 137   1          /******ç¡¬ä»¶FOè¿‡æµï¼Œæ¯”è¾ƒå™¨åˆå§‹åŒ–ï¼Œç”¨äºç¡¬ä»¶è¿‡æµæ¯”è¾ƒä¿æŠ¤******/
 138   1          #if (HardwareCurrent_Protect == Hardware_FO_Protect)                        //å¤–éƒ¨ä¸­æ–­åˆå§‹åŒ–ï¼Œç”¨äºå¤–éƒ
             -¨ä¸­æ–­ç¡¬ä»¶è¿‡æµFOçš„ä¿æŠ¤
                      EXTI_Init();
                  #elif (HardwareCurrent_Protect == Hardware_CMP_Protect)                     //é€‰æ‹©æ¯”è¾ƒè¿‡æµï¼Œæ¯”è¾ƒå™¨åˆå
             -§‹åŒ–
 141   1              CMP3_Init();
 142   1          #elif (HardwareCurrent_Protect == Hardware_FO_CMP_Protect)                  //ä¸¤è€…éƒ½é€‰æ‹©
                      EXTI_Init();
                      CMP3_Init();
                  #endif
 146   1      
 147   1          //  Sleepmode_Init();
 148   1         
 149   1          /****åŠŸèƒ½IOåˆå§‹åŒ–***********/
 150   1          GPIO_Init();
 151   1          
 152   1         /****è¿‡é›¶æ£€æµ‹å¤–éƒ¨ä¸­æ–­åˆå§‹åŒ–***********/
 153   1          ZeroCrossing_Init();
 154   1      
 155   1          /*****è¿ç®—æ”¾å¤§å™¨åˆå§‹åŒ–*********/
 156   1          AMP_Init();
 157   1      
 158   1          /*****ADCåˆå§‹åŒ–*********/
 159   1          ADC_Init();
 160   1          /****æ¯”è¾ƒå™¨ä¸­æ–­é…ç½®***********/
 161   1          CMP3_Inter_Init();                                                          // å»ºè®®å’Œæ¯”è¾ƒå™¨åˆå§‹åŒ–é—´éš”ä¸€æ®µ
             -æ—¶é—´
 162   1      
 163   1          /*****Driveråˆå§‹åŒ–*********/
 164   1          Driver_Init();
 165   1          /*****UARTåˆå§‹åŒ–*********/
 166   1          // UART_Init();//æœªé…ç½®
 167   1      
 168   1          #if defined (SPI_DBG_HW) | defined (SPI_DBG_SW)                             // è°ƒè¯•æ¨¡å¼
              //      SPI_Init();                                                             //è°ƒè¯•æ¨¡å¼ä¸‹ï¼Œå ç”¨SPIç«¯å£çš„NSS(GP04),MOSI(GP05)
             -,SCK(GP06)
                  #endif
C51 COMPILER V9.52.0.0   MAIN                                                              04/16/2020 10:07:49 PAGE 4   

 171   1          /*****Timeråˆå§‹åŒ–*******/
 172   1      //    TIM2_Init();                                                            //ç«¯å£GP07 & GP10
 173   1          TIM3_Init();                                                                //ç«¯å£GP11,é‡‡æ ·å®šæ—¶å™¨3ä¸­æ–­ä½œä¸ºPWMæ•è·ä¸­æ–­
 174   1          TIM4_Init();//ç«¯å£GP01
 175   1          TIM1ms_Init();                                                              //é‡‡ç”¨1mså®šæ—¶å™¨ä¸­æ–­ä½œä¸ºå¸¸è§ä¸­æ–­,å¤„ç†æ•…éšœ
             -ä¿æŠ¤ç­‰é™„åŠ åŠŸèƒ½
 176   1       }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    130    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      1    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
