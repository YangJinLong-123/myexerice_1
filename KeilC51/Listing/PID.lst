C51 COMPILER V9.52.0.0   PID                                                               08/28/2018 10:18:49 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE PID
OBJECT MODULE PLACED IN .\Output\PID.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE ..\User\Source\Function\PID.c LARGE OMF2 WARNINGLEVEL(0) BROWSE INCDIR(..\L
                    -ibrary\FU68xx_Hardware_Driver\Include;..\User\Include) DEBUG PRINT(.\Listing\PID.lst) TABS(2) OBJECT(.\Output\PID.obj)

line level    source

   1          /**************************** (C) COPYRIGHT 2015 Fortiortech shenzhen *****************************
   2          * File Name          : PID.c
   3          * Author             : Billy Long Fortiortech  Market Dept
   4          * Version            : V1.0
   5          * Date               : 01/07/2015
   6          * Description        : This file contains PI control function used for Motor Control.
   7          ***************************************************************************************************
   8          * All Rights Reserved
   9          **************************************************************************************************/
  10          
  11          
  12          /* Includes -------------------------------------------------------------------------------------*/
  13          #include <FU68xx.h>
  14          #include <Myproject.h>
*** ERROR C141 IN LINE 18 OF ..\User\Include\PID.h: syntax error near 'uint16'
*** ERROR C129 IN LINE 18 OF ..\User\Include\PID.h: missing ';' before 'Kp'
  15          
  16          /* Private variables ----------------------------------------------------------------------------*/
  17          bit FlagStartPI = 0;
  18          
  19          Ramp_TypeDef idata SpeedRamp;
  20          PID_TypeDef idata SpeedPID;
  21          PID_TypeDef idata CurrentPID;
  22          
  23          
  24          /*-------------------------------------------------------------------------------------------------
  25            Function Name : void SpeedPIDInit(void)
  26            Description   : é€Ÿåº¦PIDå‚æ•°åˆå§‹åŒ–
  27            Input         : æ— 
  28            Output        : æ— 
  29          -------------------------------------------------------------------------------------------------*/
  30          void SpeedPIDInit(void)
  31          {
  32            SpeedPID.Kp = TempSpeedKP;
  33            SpeedPID.Ki = TempSpeedKI;
  34            SpeedPID.Err = 0;
  35            SpeedPID.Err_Last1 = 0;
  36            SpeedPID.Err_Err = 0;
  37            #if (SpeedCloseLoopEnable)
                {
                  SpeedPID.Out = TempMotorStartDuty;
                  SpeedPID.OutMax = MotorVSMax;
                  SpeedPID.OutMin = TempMotorStartDuty;
                }
                #elif ((SpeedCloseLoopEnable)&&(CurrentCloseLoopEnable))
                {
                  SpeedPID.Out = 0;
                  SpeedPID.OutMax = TempCurrentMax;
                  SpeedPID.OutMin = TempCurrentMin;
                }
                #endif
  50          }
  51          
  52          /*-------------------------------------------------------------------------------------------------
C51 COMPILER V9.52.0.0   PID                                                               08/28/2018 10:18:49 PAGE 2   

  53            Function Name : void SpeedRampInit(void)
  54            Description   : é€Ÿåº¦çˆ¬å¡å‚æ•°åˆå§‹åŒ–
  55            Input         : æ— 
  56            Output        : æ— 
  57          -------------------------------------------------------------------------------------------------*/
  58          void SpeedRampInit(void)
  59          {
  60            SpeedRamp.RampInc = SpeedRampInc;
  61            SpeedRamp.RampDec = SpeedRampDec;
  62            SpeedRamp.RampStep = MC.SpeedCtl.PISpeed;
  63          }
  64          
  65          /*-------------------------------------------------------------------------------------------------
  66            Function Name : void CurrentPIDInit(void)
  67            Description   : ç”µæµPIå‚æ•°åˆå§‹åŒ–
  68            Input         : æ— 
  69            Output        : æ— 
  70          -------------------------------------------------------------------------------------------------*/
  71          void CurrentPIDInit(void)
  72          {
  73            CurrentPID.Kp = TempCurrentKP;
  74            CurrentPID.Ki = TempCurrentKI;
  75            CurrentPID.Err = 0;
  76            CurrentPID.Err_Last1 = 0;
  77            CurrentPID.Err_Err = 0;
  78            CurrentPID.Out = TempMotorStartDuty;
  79            CurrentPID.OutMax = MotorVSMax;
  80            CurrentPID.OutMin = TempMotorStartDuty;
  81          }
  82          
  83          /*-------------------------------------------------------------------------------------------------
  84            Function Name : int16 RampControl(Ramp_TypeDef *Ramp, int16 Ref)
  85            Description   : çˆ¬å¡æŽ§åˆ¶å‡½æ•°ï¼Œæ ¹æ®è®¾å®šçˆ¬å¡å¢žé‡æŠŠå½“å‰å€¼å‘ç›®æ ‡å€¼é æ‹¢
  86            Input         : Ramp--çˆ¬å¡å¯¹è±¡æ•°ç»„
  87                            Ref--çˆ¬å¡å‚è€ƒç›®æ ‡
  88            Output        : RampStep--çˆ¬å¡å½“å‰è¾“å‡º
  89          -------------------------------------------------------------------------------------------------*/
  90          int16 RampControl(Ramp_TypeDef *Ramp, int16 Ref)
  91          {
  92            Ramp->RampTarget = Ref;
  93            if(Ramp->RampTarget > Ramp->RampStep)
  94            {
  95              if((Ramp->RampStep + Ramp->RampInc) <= Ramp->RampTarget)
  96              {
  97                Ramp->RampStep += Ramp->RampInc;
  98              }
  99              else
 100              {
 101                Ramp->RampStep = Ramp->RampTarget;
 102              }
 103            }
 104            else if(Ramp->RampTarget < Ramp->RampStep)
 105            {
 106              if((Ramp->RampStep - Ramp->RampDec) >= Ramp->RampTarget)
 107              {
 108                Ramp->RampStep -= Ramp->RampDec;
 109              }
 110              else
 111              {
 112                Ramp->RampStep = Ramp->RampTarget;
 113              }
 114            }
C51 COMPILER V9.52.0.0   PID                                                               08/28/2018 10:18:49 PAGE 3   

 115          
 116            return  Ramp->RampStep;
 117          }
 118          
 119          /*-------------------------------------------------------------------------------------------------
 120            Function Name : int16 PIDControl(PID_TypeDef *PID, int16 Ref, int16 Cur)
 121            Description   : PIè°ƒèŠ‚å‡½æ•°
 122            Input         : PID--PIè°ƒèŠ‚å¯¹è±¡æ•°ç»„
 123                            Ref--PIè°ƒèŠ‚å‚è€ƒç›®æ ‡
 124                            Cur--PIå½“å‰è¾“å…¥
 125            Output        : Out--PIè°ƒèŠ‚è¾“å‡º
 126          -------------------------------------------------------------------------------------------------*/
 127          int16 PIDControl(PID_TypeDef *PID, int16 Ref, int16 Cur)
 128          {
 129            int32 Kp_Out, Ki_Out, PID_Out;
 130          
 131            /*PIè¿ç®—æ—¶é—´67us*/
 132            if(!PID->Err)
 133            {
 134              PID->Err_Last1 = Ref - Cur;                            // åˆå§‹åŒ–PIDä¸Šæ¬¡åå·®
 135              PID->Err = Ref - Cur;                                  // åˆå§‹åŒ–PIDå½“å‰åå·®
 136              PID->Err_Err=PID->Err - PID->Err_Last1;                // åˆå§‹åŒ–PIDä¸Šæ¬¡åå·®å’Œä¸Šä¸Šæ¬¡åå·®ä¹‹å·®
 137            }
 138            else
 139            {
 140              PID->Err_Last1 = PID->Err;                             // ä¿å­˜PIDä¸Šæ¬¡åå·®
 141              PID->Err = Ref - Cur;                                  // è®¡ç®—PIDå½“å‰åå·®
 142              PID->Err_Err=PID->Err - PID->Err_Last1;                // è®¡ç®—PIDä¸Šæ¬¡åå·®å’Œä¸Šä¸Šæ¬¡åå·®ä¹‹å·®
 143            }
 144          
 145            Kp_Out = ((int32)PID->Kp * (int32)PID->Err_Err) >> 12;
 146            Ki_Out = ((int32)PID->Ki * (int32)PID->Err) >> 12;
 147          
 148            PID_Out = PID->Out;
 149            PID_Out += Kp_Out + Ki_Out;
 150          
 151            if(PID_Out > PID->OutMax)
 152            {
 153              PID_Out = PID->OutMax;                                 // PIDæœ€é«˜è¾“å‡º
 154            }
 155            if(PID_Out < PID->OutMin)
 156            {
 157              PID_Out = PID->OutMin;                                 // PIDæœ€ä½Žè¾“å‡º
 158            }
 159            PID->Out = PID_Out;
 160          
 161            return PID->Out;
 162          }
 163          
 164          /*-------------------------------------------------------------------------------------------------
 165            Function Name : int16 PIDControl(PID_TypeDef *PID, int16 Ref, int16 Cur)
 166            Description   : PIè°ƒèŠ‚å‡½æ•°
 167            Input         : PID--PIè°ƒèŠ‚å¯¹è±¡æ•°ç»„
 168                            Ref--PIè°ƒèŠ‚å‚è€ƒç›®æ ‡
 169                            Cur--PIå½“å‰è¾“å…¥
 170            Output        : Out--PIè°ƒèŠ‚è¾“å‡º
 171          -------------------------------------------------------------------------------------------------*/
 172          int16 PID_Control(PID_TypeDef *PID, int16 Ref, int16 Cur)
 173          {
 174            int16 Kp_Out;
 175            int16 Ki_Out;
 176            int32 PID_Out;
C51 COMPILER V9.52.0.0   PID                                                               08/28/2018 10:18:49 PAGE 4   

 177          
 178            /*PIè¿ç®—æ—¶é—´42us*/
 179            if(!PID->Err)
 180            {
 181              PID->Err_Last1 = Ref - Cur;                            // åˆå§‹åŒ–PIDä¸Šæ¬¡åå·®
 182              PID->Err = Ref - Cur;                                  // åˆå§‹åŒ–PIDå½“å‰åå·®
 183              PID->Err_Err=PID->Err - PID->Err_Last1;                // åˆå§‹åŒ–PIDä¸Šæ¬¡åå·®å’Œä¸Šä¸Šæ¬¡åå·®ä¹‹å·®
 184            }
 185            else
 186            {
 187              PID->Err_Last1 = PID->Err;                             // ä¿å­˜PIDä¸Šæ¬¡åå·®
 188              PID->Err = Ref - Cur;                                  // è®¡ç®—PIDå½“å‰åå·®
 189              PID->Err_Err=PID->Err - PID->Err_Last1;                // è®¡ç®—PIDä¸Šæ¬¡åå·®å’Œä¸Šä¸Šæ¬¡åå·®ä¹‹å·®
 190            }
 191          
 192            Kp_Out = MDU_MULA_S16(PID->Kp, PID->Err_Err, 12);
 193            Ki_Out = MDU_MULA_S16(PID->Ki, PID->Err, 12);
 194            PID_Out = PID->Out;
 195            PID_Out += Kp_Out + Ki_Out;
 196          
 197            if(PID_Out > PID->OutMax)
 198            {
 199              PID_Out = PID->OutMax;                                 // PIDæœ€é«˜è¾“å‡º
 200            }
 201            if(PID_Out < PID->OutMin)
 202            {
 203              PID_Out = PID->OutMin;                                 // PIDæœ€ä½Žè¾“å‡º
 204            }
 205            PID->Out = PID_Out;
 206          
 207            return PID->Out;
 208          }
 209          
 210          /*-------------------------------------------------------------------------------------------------
 211            Function Name : void PI_Init(void)
 212            Description   : PIæ¨¡å—åˆå§‹åŒ–
 213            Input         : æ— 
 214            Output        : æ— 
 215          -------------------------------------------------------------------------------------------------*/
 216          void PI_Init(void)
 217          {
 218          /*-------------------------------------------------------------------------------------------------
 219            PIæ•°æ®æ ¼å¼
 220            Q = PIRANGE + 8(Q8~Q23æ•°æ®æ ¼å¼)
 221            ç»™å¯„å­˜å™¨èµ‹å€¼æ—¶è¦ç»Ÿä¸€æ•°æ®æ ¼å¼
 222          -------------------------------------------------------------------------------------------------*/
 223            SetBit(SV_CR, PIRANGE3, 0);                             // 0100: 12bit PI
 224            SetBit(SV_CR, PIRANGE2, 1);
 225            SetBit(SV_CR, PIRANGE1, 0);
 226            SetBit(SV_CR, PIRANGE0, 0);                              // PIæˆªä½Q=PIRANGE+8ï¼Œå³PIæ•°æ®æ ¼å¼
 227          
 228            PI_KP = 0;                                               // å¯„å­˜å™¨æ•°æ®ç±»åž‹ï¼šint16 Q12æ ¼å¼ï¼ŒPI_KP=Kp*2^12ï
             -¼Œ
 229            PI_KI = 0;                                               // å¯„å­˜å™¨æ•°æ®ç±»åž‹ï¼šint16 Q12æ ¼å¼ï¼ŒPI_KI=Kp*2^12
 230            PI_EK = 0;
 231            PI_UK = 0;                                               // å¯„å­˜å™¨æ•°æ®ç±»åž‹ï¼šint16
 232            PI_UKMAX = 0;                                            // å¯„å­˜å™¨æ•°æ®ç±»åž‹ï¼šint16
 233            PI_UKMIN = 0;                                            // å¯„å­˜å™¨æ•°æ®ç±»åž‹ï¼šint16
 234          }
 235          
 236          /*-------------------------------------------------------------------------------------------------
 237            Function Name : int16 PIDControl(PID_TypeDef *PID, int16 Ref, int16 Cur)
C51 COMPILER V9.52.0.0   PID                                                               08/28/2018 10:18:49 PAGE 5   

 238            Description   : PIè°ƒèŠ‚å‡½æ•°
 239            Input         : PID--PIè°ƒèŠ‚å¯¹è±¡æ•°ç»„
 240                            Ref--PIè°ƒèŠ‚å‚è€ƒç›®æ ‡
 241                            Cur--PIå½“å‰è¾“å…¥
 242            Output        : Out--PIè°ƒèŠ‚è¾“å‡º
 243          -------------------------------------------------------------------------------------------------*/
 244          int16 PI_Control(PID_TypeDef *PID, int16 Ref, int16 Cur)
 245          {
 246            static uint8 *PIDType = 0;
 247          
 248            /*PIè¿ç®—æ—¶é—´10us*/
 249            FlagStartPI = 1;
 250            while(FlagStartPI)                                       // MDUåˆ†æ—¶å¤ç”¨æ ‡å¿—
 251            {
 252              FlagStartPI = 0;
 253          
 254              /*æŒ‡é’ˆç±»åž‹æ•°æ®åˆ¤æ–­æ‰§è¡Œæ—¶é—´2.5us*/
 255              if(PIDType != PID)                                     // é€šè¿‡PIDæ•°æ®åœ°å€èŽ·å–PIDç±»åž‹ï¼Œ
 256              {
 257                PIDType = PID;
 258          
 259                PI_KP = PID->Kp;                                     // å¯„å­˜å™¨æ•°æ®ç±»åž‹ï¼šint16 Q12æ ¼å¼ï¼ŒPI_KP=Kp*2^12ï
             -¼Œ
 260                PI_KI = PID->Ki;                                     // å¯„å­˜å™¨æ•°æ®ç±»åž‹ï¼šint16 Q12æ ¼å¼ï¼ŒPI_KI=Kp*2^12
 261                PI_EK = PID->Err;
 262                PI_UK = PID->Out;                                    // å¯„å­˜å™¨æ•°æ®ç±»åž‹ï¼šint16
 263                PI_UKMAX = PID->OutMax;                              // å¯„å­˜å™¨æ•°æ®ç±»åž‹ï¼šint16
 264                PI_UKMIN = PID->OutMin;                              // å¯„å­˜å™¨æ•°æ®ç±»åž‹ï¼šint16
 265          
 266                SetBit(SV_CR,PISTA,1);                               // å¯åŠ¨PI
 267                _nop_();
 268                _nop_();
 269                _nop_();
 270                _nop_();
 271                _nop_();                                             // ç­‰å¾…PIè¿ç®—å®Œæˆ,PI_LastErråˆå§‹åŒ–æˆ
 272          
 273              }
 274              /*èµ‹å€¼è¿ç®—æ—¶é—´3.2us*/
 275              PID->Err = Ref - Cur;                                  // è®¡ç®—PIDå½“å‰åå·®
 276          
 277              /*PIç¡¬æ ¸è¿ç®—æ—¶é—´1.8us*/
 278              PI_EK = PID->Err;                                      // PIè¾“å…¥
 279              PI_UK = PID->Out;                                      // å¯„å­˜å™¨æ•°æ®ç±»åž‹ï¼šint16
 280              SetBit(SV_CR,PISTA,1);
 281              _nop_();
 282              _nop_();
 283              _nop_();
 284              _nop_();
 285              _nop_();
 286              PID->Out = PI_UK;                                       // PIè¾“å‡º
 287            }
 288            FlagStartPI = 1;
 289          
 290            return PID->Out;
 291          }
 292          

C51 COMPILATION COMPLETE.  0 WARNING(S),  2 ERROR(S)
